<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="../styles/static-styles.html">
<link rel="import" href="addons/sc-static-page.html">
<link rel="import" href="sc-languages-import.html">
<link rel="import" href="sc-cache-utility.html">

<dom-module id="sc-offline-page">
  <template>
    <style include="static-styles">

      .button {
        @apply --sc-skolar-font-size-s;
        background-color: var(--sc-primary-accent-color);
        color: var(--sc-tertiary-text-color);
        font-weight: bold;
        text-align: center;
        margin: var(--sc-size-lg);
      }

      .button-container {
        display: flex;
        flex-direction: row;
        justify-content: flex-end;
      }

      .icon {
        margin: var(--sc-size-sm);
      }

      .success-icon {
        color: var(--sc-toast-success-color);
      }

      .failure-icon {
        color: var(--sc-toast-error-color);
      }

    </style>

    <iron-ajax id="ajax" reject-with-request="true"></iron-ajax>

    <iron-meta id="meta"></iron-meta>

    <sc-cache-utility id="cache_utility"></sc-cache-utility>

    <div id="page-wrap">
      <main>
        <section>
          <article>
            <h1>Using SuttaCentral offline</h1>
            <p>SuttaCentral is a <a href="https://developers.google.com/web/progressive-web-apps/" target="_blank">Progressive
              Web App</a>. On supported devices, many features, including navigation and previously visited pages, will
              continue to work even if you have no internet connection.</p>
            <p>In addition, you can download texts in languages of your choosing and read them when offline. This is
              especially useful for users on mobiles with limited data, or in regions with poor coverage. If your data
              is limited, we recommend connecting to wifi before downloading.</p>
            <p>PWAs are a new technology. For now, offline usage has some limitations:</p>
            <ul>
              <li>Suttas only, not Vinaya or Abhidhamma.</li>
              <li>Only one language.</li>
              <li>No original texts.</li>
              <li>Certain functions, including search, require internet connection.</li>
            </ul>
            <p>If you want extra features, let us know.</p>

            <div class="button-container">
              <paper-button raised disabled="[[!browserSupportsPWA]]" id='make_offline_button' class="button">
                Download texts in [[languageName]]
              </paper-button>
              <div class="button-info">
                <p>
                  <template is="dom-if" if="[[browserSupportsPWA]]">
                    <span>Your browser supports Progressive Web Apps!</span>
                    <iron-icon icon="icons:check-box" class="icon success-icon"></iron-icon>
                  </template>
                  <template is="dom-if" if="[[!browserSupportsPWA]]">
                    <span>Your browser does not support Progressive Web Apps.</span>
                    <iron-icon icon="icons:error" class="icon failure-icon"></iron-icon>
                    <br>
                    <a href="https://caniuse.com/#feat=serviceworkers">
                      Here is a list of supported browsers.
                    </a>
                  </template>
                </p>
                <p>
                  If you would like to choose a different language, select one from the menu.
                </p>
              </div>
            </div>
          </article>
        </section>
      </main>
    </div>
  </template>

  <script>
      class SCOfflinePage extends SCStaticPage {
          static get is() {
              return 'sc-offline-page';
          }

          static get properties() {
              return {
                  localizedStringPath: {
                      type: String,
                      value: '/localization/elements/sc-offline-page/'
                  },
                  browserSupportsPWA: {
                      type: Boolean,
                      computed: '_doesBrowserSupportPWA()'
                  },
                  languageName: {
                      type: String,
                      computed: '_getNativeLanguageName(language)'
                  }
              }
          }

          connectedCallback() {
              super.connectedCallback();
              const offlineButton = this.$.make_offline_button;
              if (offlineButton) {
                  offlineButton.addEventListener('click', () => { this.makeOffline() });
              }
          }

          makeOffline() {
              this.$.ajax.url = this._getCollectionUrl('sutta');
              this._showToast('info', `Your download has commenced.
                You can keep using the site and we will let you know when itâ€™s complete.`);
              this.$.ajax.generateRequest().completes.then(
                  (request) => {
                      const response = request.__data.response;
                      const allURLs = this._buildUrlList(response);
                      this._cacheAllItems(allURLs);
                  }, (error) => {
                      this._showToast('error', 'Network error.');
                      console.error(error);
                      return;
                  });
          }

          _cacheAllItems(allURLs) {
              const cacheUtility = this.shadowRoot.querySelector('#cache_utility');
              cacheUtility.processRequests(allURLs).then(([passed, failed]) => {
                  if (failed === 0 && passed > 0) {
                      this._showToast('success', `Your download is complete.
                            You may now read suttas in ${this._getNativeLanguageName(this.language)} offline.`);
                  } else if (failed > 0) {
                      this._showToast('error', `Error! We were not able to download all the requested texts.
                            ${failed} out of ${passed + failed} requests did not complete correctly.`);
                  } else {
                      this._showToast('error', 'Network error.');
                  }
              });
          }

          _buildUrlList(response) {
              const menuURLs = response.menu.map(menuId => this._getMenuUrl(menuId));
              const suttaplexURLs = response.suttaplex.map(suttaplexId => this._getSuttaplexUrl(suttaplexId));
              const suttaTextURLs = [];
              response.texts.forEach((text) => {
                  text.translations.forEach((translation) => {
                      translation.authors.forEach((author) => {
                          suttaTextURLs.push(this._getSuttaTextUrl(text.uid, author, translation.lang));
                      })
                  })
              });
              return menuURLs.concat(suttaplexURLs).concat(suttaTextURLs);
          }

          _getCollectionUrl(collection) {
              return `${this.$.meta.byKey('API_ROOT')}/pwa/collection/${collection}?languages=${this.language}`;
          }

          _getMenuUrl(menuItemId) {
              return `${this.$.meta.byKey('API_ROOT')}/menu/${menuItemId}?language=${this.language}`;
          }

          _getSuttaplexUrl(suttaplexId) {
              return `${this.$.meta.byKey('API_ROOT')}/suttaplex/${suttaplexId}?language=${this.language}`;
          }

          _getSuttaTextUrl(suttaId, authorId, langIsoCode) {
              return `${this.$.meta.byKey('API_ROOT')}/suttas/${suttaId}/${authorId}?lang=${langIsoCode}`;
          }

          _doesBrowserSupportPWA() {
              return ('serviceWorker' in navigator);
          }

          _getNativeLanguageName(languageIsoCode) {
              return languages.getLanguageInfo(languageIsoCode).nativeName;
          }

          _showToast(type, inputMessage) {
              this.dispatchEvent(new CustomEvent('show-sc-toast', {
                  detail: {
                      toastType: type,
                      message: inputMessage
                  },
                  bubbles: true,
                  composed: true
              }));
          }
      }

      customElements.define(SCOfflinePage.is, SCOfflinePage);
  </script>
</dom-module>