<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="/elements/sc-segmented-text.html">
<link rel="import" href="/elements/sc-page-text.html">

<dom-module id="sc-text-page-selector">
  <template>
    <iron-meta id="meta"></iron-meta>

    <iron-ajax
        auto
        url="[[_getUrl()]]"
        handle-as="json"
        loading="{{loading}}"
        last-error="{{error}}"
        last-response="{{lastResponse}}"
    ></iron-ajax>

    <template is="dom-if" if="[[!isSegmentedText]]" restamp>
      <sc-page-text></sc-page-text>
    </template>

    <template is="dom-if" if="[[isSegmentedText]]" restamp>
      <sc-segmented-text></sc-segmented-text>
    </template>

    <template is="dom-if" if="[[error]]">
      <h2>Page error</h2>
      <h3>Could not load the sutta text.</h3>
    </template>


  </template>

  <script>
      class SCTextPageSelector extends ReduxMixin(Polymer.Element) {
          static get is() {
              return 'sc-text-page-selector';
          }

          static get properties() {
              return {
                  isSegmentedText: {
                      type: Boolean,
                      computed: '_isSegmentedSuttaTextPage'
                  },
                  lastResponse: {
                      type: Object,
                      observer: '_onResponse'
                  },
                  author: {
                      type: String,
                      statePath: 'currentRoute.authorName'
                  },
                  suttaUid: {
                      type: String,
                      statePath: 'currentRoute.authorName'
                  },
                  langIsoCode: {
                      type: String,
                      statePath: 'currentRoute.authorName'
                  }
              }
          }

          static get actions() {
              return {
                  changeToolbarTitle(title) {
                      return {
                          type: 'CHANGE_TOOLBAR_TITLE',
                          title: title
                      };
                  },
                  changeToolbarMode(mode) {
                      return {
                          type: 'CHANGE_TOOLBAR_MODE',
                          mode: mode
                      };
                  }
              }
          }

          _onResponse() {
              // todo check if segmented
              if (this.isSegmentedText) {
                  this.dispatch('changeToolbarMode', 'segmented-mode');
              }
              else {
                  this.dispatch('changeToolbarMode', 'text-mode');
              }
          }

          // checks if a page is a segmented-text page and sets the toolbar title and css class accordingly.
          _isSegmentedSuttaTextPage() {
              return !!(langIsoCode && author && (author === 'sujato' || author === 'pali'));
          }

          _getUrl() {
              return `${this.$.meta.byKey('API_ROOT')}/suttas/${suttaUid}/${author}`;
          }
      }

      customElements.define(SCTextPageSelector.is, SCTextPageSelector);
  </script>
</dom-module>