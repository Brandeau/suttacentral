<link rel="import" href="/../bower_components/polymer/polymer.html">
<link rel="import" href="/../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="/../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="/../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/../bower_components/paper-input/paper-input.html">
<link rel="import" href="/../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="/../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="/../bower_components/iron-location/iron-location.html">

<link rel="import" href="/../elements/menus/sc-more-menu.html">

<!--
Base toolbar that appear on the top right in the header of every page. Not all items are shown on all pages
This toolbar is called from the page-selector.

Issues:
  - The paper badge that appears only on text-pages next to the link to the Discourse forum now only shows
    the number 20 but it should show the correct search results instead.
  - The paper badge has the annoying habit of occasionally disappearing for no apparent reason.
    It seems that it calculates the position too far to the right so as to go off the screen.
    `this.shadowRoot.querySelector('paper-badge').updatePosition();` does not seem to work to rectify this. It seems to also
    show this behavior here: https://github.com/PolymerElements/paper-badge/pull/12 and briefly show in
    the correct position but then disappear to the right.
-->
<dom-module id="sc-toolbar">
  <template>
    <style is="custom-style">
      .white-icon {
        color: white;
      }

      .toolbar-paper-button {
        --paper-menu-button-dropdown: {
          max-width: 100%;
        };
      }

      .toolbar-input {
        display: inline-block;
        vertical-align: text-bottom;
        --paper-input-container: {
          padding: 0;
        };
        --paper-input-container-color: white;
        --paper-input-container-focus-color: white;
        --paper-input-container-label: {
          color: white;
          opacity: 0.6;
        };
        --paper-input-container-input: {
          color: white;
        };
      }

      .toolbar-badge {
        --paper-badge-background: var(--paper-green-a700);
      }

      #closebutton {
        display: none;
      }

      #searchInput {
        width: 0;
        transition: width .2s cubic-bezier(.4, 0, .2, 1);
      }

      .hidebutton {
        display: none;
      }

      .toolbar-link {
        text-decoration: none;
      }

      .search-open #discoursebutton, .search-open > #morevertbutton {
        display: none;
      }
    </style>

    <iron-location path="{{path}}" query="{{query}}"></iron-location>

    <div id="toolsmenu">
      <!-- Search field. iron-a11y-keys fires when the enter-key is pressed-->
      <iron-a11y-keys target="{{searchInput}}" keys="enter" on-keys-pressed="startSearch"></iron-a11y-keys>
      <paper-icon-button icon="search" class="white-icon" on-tap="openSearch"></paper-icon-button>
      <paper-input class="toolbar-input" label="Search" no-label-float id="searchInput"></paper-input>
      <paper-icon-button icon="close" class="white-icon" id="closebutton" on-tap="closeSearch"></paper-icon-button>

      <!-- Link to Discourse.suttacentral.net. On sutta-pages with a search for that resp. sutta. -->
      <a class="toolbar-link" tabindex="-1" target="_blank">
        <paper-icon-button id="discoursebutton" class="white-icon" icon="communication:forum"></paper-icon-button>
      </a>

      <paper-badge class="toolbar-badge" hidden for="discoursebutton" label="20"
                   title="This text has 20 references"></paper-badge>

      <!-- Menu for more options like language and other static pages -->
      <paper-menu-button class="toolbar-paper-button" horizontal-align="right" ignore-select id="morevertbutton">
        <paper-icon-button icon="more-vert" class="white-icon" slot="dropdown-trigger"></paper-icon-button>
        <div slot="dropdown-content"></div>
        <paper-listbox slot="dropdown-content" tabindex="0">
          <sc-more-menu></sc-more-menu>
        </paper-listbox>
      </paper-menu-button>
    </div>
  </template>

  <script>
      class SCToolbar extends ReduxMixin(Polymer.Element) {
          static get is() {
              return 'sc-toolbar'
          }

          static get properties() {
              return {
                  inputLanguage: String,

                  // If suttaPath exists, it means that there is an author and that this is a text-page with
                  // different elements showing.
                  suttaPath: {
                      type: String,
                      value: '',
                      notify: true
                  },
                  category: String,

                  // Value of the meta data of the text-pages that is passed onto the settings-menu dialog
                  metaArea: {
                      type: String,
                      notify: true
                  },

                  // The input on the search box
                  searchInput: String
              }
          }

          static get actions() {
              return {
                  initiateSearch(searchQuery) {
                      return {
                          type: 'INITIATE_SEARCH',
                          query: searchQuery
                      };
                  }
              }
          }

          // When looking-glass icon is clicked, determines if the searchbox is already open and if so, starts the search.
          // If not, it opens the search box and moves other elements out of the way depending on the width of the screen.
          openSearch() {
              if (this.shadowRoot.querySelector('#searchInput').classList.contains('opened')) {
                  this.startSearch();
              } else {
                  this.shadowRoot.querySelector('#searchInput').classList.add('opened');
                  this.shadowRoot.querySelector('#searchInput').focus();
                  this.shadowRoot.querySelector('#closebutton').style.display = 'inline-block';
                  this.shadowRoot.querySelector('#searchInput').value = '';
                  let searchSize = 500;
                  if (this.suttaPath) {
                      searchSize = 540
                  }
                  if (window.innerWidth < 1040) {
                      Polymer.dom(this.root.host.offsetParent).querySelector('#toolbartitlebox')
                          .setAttribute('style', 'visibility:hidden')
                  }
                  let searchWidth;
                  if (window.innerWidth > 840) {
                      searchWidth = window.innerWidth - searchSize;
                  } else if (window.innerWidth > 480) {
                      searchWidth = window.innerWidth - (searchSize - 210);
                  } else {
                      this.shadowRoot.querySelector('#toolsmenu').classList.add('search-open');
                      if (this.suttaPath) {
                          searchSize = 500
                      }
                      searchWidth = window.innerWidth - (searchSize - 320);
                  }
                  if (searchWidth > 360) {
                      searchWidth = 360
                  }
                  this.shadowRoot.querySelector('.opened').style.width = searchWidth;
              }
          }

          // Closes the searchbox and resets original values.
          closeSearch() {
              if (this.shadowRoot.querySelector('#searchInput').classList.contains('opened')) {
                  this.shadowRoot.querySelector('#searchInput').classList.remove('opened');
                  this.shadowRoot.querySelector('#searchInput').removeAttribute('style', 'width');
                  this.shadowRoot.querySelector('#closebutton').style.display = 'none';
                  this.shadowRoot.querySelector('#toolsmenu').classList.remove('search-open');
                  Polymer.dom(this.root.host.offsetParent).querySelector('#toolbartitlebox')
                      .removeAttribute('style', 'display');
              }
          }

          // Initiates the search function.
          startSearch() {
              const searchQuery = this.shadowRoot.querySelector('#searchInput').value;
              this.set('path', '/search');
              this.set('query', `query=${searchQuery}`);
              this.dispatch('initiateSearch', searchQuery);
          }

      }

      customElements.define(SCToolbar.is, SCToolbar);
  </script>
</dom-module>