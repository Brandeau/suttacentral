<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
 <link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="menus/search-menu.html">

<dom-module id="sc-page-search">
<template>
<style is="custom-style">
.divisioncontent {
  @apply --sc-sans-font;
  padding: 72px 0;
}

main {
    max-width:720px;
    margin:0 auto;
}
.results-head{
    display:flex;
    justify-content:  space-between ;
    padding: 0 16px;
    color:var(--secondary-text-color);
}
h1{
    @apply --paper-font-display1;
    display: inline-block;
    margin: 0;
}

.result-term{
    font-weight: bold;
    color: var(--sc-green-600);
    @apply --sc-serif-font;
}

    iron-list {
      padding: 28px 0 16px;
    }

    .item {
      @apply --layout-horizontal;
      border-bottom: 1px solid var(--paper-grey-300);
    }

    .item:focus {
      outline: 0;
      background: linear-gradient(to right, rgba(67, 160, 7, 1) 4px, rgba(67, 160, 7, 0) 4px);
    }

    .pad {
      padding: 0 16px;
      @apply --layout-flex;
      @apply --layout-vertical;
    }

h2{
    @apply --paper-font-headline;
    color: var(--sc-green-600);
    margin: 22px 0 0 0;
}
.results-url{
    @apply --paper-font-body2;
    color:var(--secondary-text-color);
    white-space: nowrap;
    margin: 0 0 16px;
    overflow: hidden;
}
.snippet{
    @apply --sc-paper-font-body;
    margin: 0 0 20px 0;
}
search-menu {
    margin-top: -20px;
}
.hidesearchbox {
    display: none;
}
paper-spinner-lite {
    --paper-spinner-color: var(--sc-gold-500);
    left: 50%;
    top: 50px;
}
a {
    text-decoration: none;
    color: initial;
}
.map {
  height: 480px;
  margin-bottom: 20px;
}
.map iframe {
  height: 480px;
  width: 100%;
  border:none;
}
</style>

<iron-ajax id="ajax"
          url="../data/search/results2.json"
          params='{"results": 20}'
          handle-as="json"
          loading="{{loadingResults}}"
          last-response="{{data}}"
          on-response="_didRespond"></iron-ajax>

    <div class="loadingIndicator">
      <paper-spinner-lite active="{{loadingResults}}"></paper-spinner-lite>
    </div>

<div class="divisioncontent">
    <main>
        <div class="results-head">
                    <h1><span class="result-number">[[_calculateNumber(data)]]</span> <span class="result-description">results for</span> <span class="result-term">[[searchQuery]]</span> </h1>
                    <search-menu class$="[[searchMenu]]"></search-menu>
        </div>

    <iron-scroll-threshold id="scrollThreshold" lower-threshold="0" on-lower-threshold="_load" scroll-target="document">
      <iron-list id="list" items="[]" as="item" scroll-target="document">
        <template>
          <div>
            <div class="item" tabindex$="[[tabIndex]]">
              <div class="pad">
                <template is="dom-if" if="[[_checkCategory(item.category)]]">
                    <a href="/define/[[item.title]]">
                        <div class="primary"><h2>[[item.title]]</h2></div>
                        <div class="secondary"><p class="results-url">[[item.url]]</p></div>
                    </a>
                        <div class="secondary"><p class="snippet" inner-h-t-m-l="[[item.text]]"></p></div>
                </template>

                <template is="dom-if" if="[[!_checkCategory(item.category)]]">
                      <a href="[[item.url]]">
                        <div class="primary"><h2>[[item.title]]</h2></div>
                        <div class="secondary"><p class="results-url" inner-h-t-m-l="https://suttacentral.net[[item.url]]"></p></div>
                      </a>
                        <div class="secondary"><p class="snippet" inner-h-t-m-l="[[item.text]]"></p></div>

                </template>

                <template is="dom-if" if="[[item.map]]">
                  <div class="map">
                       <iframe src="https://www.google.com/maps/d/embed?mid=z1fKgOqM_IYc.k-W6AbJIxLu8&z=13&ll=[[item.map]]"></iframe>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </template>
      </iron-list>
    </iron-scroll-threshold>

</main>
</div>
</template>
<script>
    Polymer({
      is: 'sc-page-search',
      properties: {
        searchQuery: {
            type: String,
            notify: true
        },
        inputLanguage: String,
        searchMenu: {
            type: String,
            notify: true,
            computed: '_computeSearchClass(data)'
        },
        data: {
          type: Array,
          notify: true
        },
        partArray: {
          type: Array,
          notify: true,
          value: []
        },
        showArray: {
          type: Array,
          notify: true,
          value: []
        },
        itemCount: {
            type: Number,
            value: 0
        },
        // Number of items to be loaded on first load
        firstLoad: {
          type: Number,
          value: 10
        },
        // Number of items to be loaded each time the scroll threshold is reached
        loadNumber: {
          type: Number,
          value: 5
        }
      },
      observers: [
            '_populateList(partArray)'
      ],
      ready: function() {
        this.addEventListener('eventFromSearchMenu', this.changeSearchView);
        this.$.ajax.generateRequest();
      },
      _calculateNumber: function(data) {
        return (data && data.length > 0) ? data.length: 0;
      },
      _checkCategory: function(category) {
        return (category === "dictionary") ? true : false;
      },
      _computeSearchClass: function(data) {
        var checkcategories = false;
        if (data.length > 10) {
           for (var i=1; i<data.length; i++) {
                    if (data[i].category !== data[1].category) {
                        checkcategories = true;
                        break;
                   }
            }
        }
        return (checkcategories) ? "" : "hidesearchbox";
      },
      changeSearchView: function(event) {
        var selectedView = "all";
        switch (event.detail.searchView) {
          case 0:
            selectedView = "all";
            break;
          case 1:
            selectedView = "root-text";
            break;
          case 2:
            selectedView = "translation";
            break;
          case 3:
            selectedView = "dictionary";
            break;
        }
        var outputData = this.data;
        var resultsArray = [];
        for (var i = 0; i < outputData.length; i++) {
          if (outputData[i].category === selectedView || selectedView === 'all') {
              resultsArray.push(outputData[i]);
          }
        }
        this.partArray = resultsArray;
      },
      _didRespond: function(e) {
        var self = this;
        var results = e.detail.response;
        resultsArray = [];
        results.forEach(function(item) {
            resultsArray.push(item);
        });
        this.partArray = resultsArray;
      },
      _populateList: function(partArray) {
        this.$.list.items.length = 0;
          if (partArray.length > 0) {
                    this.itemCount = 0;
                    for (var i = 0; i < this.firstLoad; i++) {
                          this.$.list.push('items',partArray[i]);
                          this.itemCount += 1;
                    }
                    this.newListCreated = false;
            } 
          this.$.scrollThreshold.clearTriggers();
      },
      _load: function() {
        // console.log(" itemCount= ", this.itemCount);
        if (this.itemCount > (this.firstLoad-1) && this.itemCount < this.partArray.length) {
            for (var i = 0; i < this.loadNumber; i++) {
                  this.$.list.push('items',this.partArray[this.itemCount]);
                  this.itemCount += 1;
            }
        }
        this.$.scrollThreshold.clearTriggers();
      }
    });
</script>
</dom-module>
