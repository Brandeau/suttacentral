<link rel="import" href="/../bower_components/polymer/polymer.html">
<link rel="import" href="/../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="/../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">

<link rel="import" href="/../elements/addons/sc-text-node.html">
<link rel="import" href="/../styles/sc-text-styles.html">
<link rel="import" href="/../styles/sc-text-heading-styles.html">
<link rel="import" href="/../styles/sc-text-paragraph-num-styles.html">

<!--
The relevant suttaplex card is shown at the top, hidden behind a dropdown (`addons/sc-text-node.html`).
Paragraph numbers can be displayed or hidden as requested via the settings-menu in the toolbar.
Title, full Author name and Meta data are sent via events to the page-selector for use in the toolbar.
-->
<dom-module id="sc-page-text" attributes="suttatitle suttameta">
  <template>
    <style include="sc-text-styles sc-text-heading-styles sc-text-paragraph-num-styles">
      .not-found {
        @apply --paper-font-display1;
      }
    </style>

    <iron-meta id="meta"></iron-meta>

    <iron-ajax id="ajax"
               url="[[_computeURL(suttaPath,author)]]"
               handle-as="text"
               last-response="{{lastResponse}}"
               on-response="_onResponse"
               last-error='{{notFound}}'></iron-ajax>

    <!--<iron-ajax id="ajaxParagraphs"-->
    <!--url="../data/paragraphtitles.json"-->
    <!--handle-as="json"-->
    <!--last-response="{{paragraphTitles}}"-->
    <!--on-response="_computePars"></iron-ajax>-->

    <template is="dom-if" if="[[notFound]]">
      <p class="not-found">Sorry, the page you requested does not exist.</p>
    </template>

    <template is="dom-if" if="[[!notFound]]">
      <sc-text-node category="[[suttaPath]]" suttaplex-item="[[suttaplex]]"></sc-text-node>
      <div id="html_text_content" inner-h-t-m-l="[[suttaText]]"></div>
    </template>
  </template>

  <script>
      class SCPageText extends Polymer.Element {
          static get is() { return 'sc-page-text' }

          static get properties() {
              return {
                  suttaPath: {
                      type: String
                  },
                  author: {
                      type: String
                  },
                  suttaText: {
                      type: String,
                      value: ''
                  },
                  inputLanguage: String,
                  notFound: Object,

                  // If true, shows the paragraph numbers on the right of the text.
                  // Data is passed on from the toolbar-settings-menu.
                  showParagraphs: {
                      type: Boolean,
                      observer: '_addParagraphs'
                  },
                  paragraphTitles: Object,
                  suttaplex: Object
              }
          }

          static get observers() {
              return [
                  '_callAjax(suttaPath,author)'
              ]
          }

          ready() {
              super.ready();
              console.log('in normal text');
          }


          // Calls the correct sutta text file. Because Polymer tends to load automatic ajax functions first from where they
          // called before parsing the route to the correct page, the additional checks are needed and might have to be
          // adjusted when more authors are added for the segmented text pages.
          _callAjax() {
              return (this.author && this.author !== 'sujato' && this.author !== 'pali') ? this.$.ajax.generateRequest() : '';
          }

          _computeURL(suttaUid, author) {
              return `${this.$.meta.byKey('API_ROOT')}/suttas/${suttaUid}/${author}`;
          }

          _onResponse() {
              if (typeof(this.lastResponse) !== 'object') {
                  this.lastResponse = JSON.parse(this.lastResponse);
              }
              try {
                  this.suttaText = this.lastResponse.root_text.text;
              } catch (e) {
                  this.suttaText = '<section><h2>Could not find sutta text in database.</h2></section>';
              }
              this.suttaplex = this.lastResponse.suttaplex;
              this.sendInfoToToolbar();
              //              this.$.ajaxParagraphs.generateRequest();
          }

          // adds a class to the main container to either show or hide paragraph numbers.
          _addParagraphs() {
              const infotext = this.shadowRoot.querySelector('#html_text_content');
              return (infotext && !this.showParagraphs) ? infotext.classList.remove('infomode') : (infotext) ? infotext.classList.add('infomode') : '';
          }

          // returns the division-text title from the loaded sutta text
          _computeTitle() {
              let title;
              try {
                  title = this.lastResponse.root_text.title;
              } catch (e) {
                  title = ''
              }
              return title;
          }

          // returns the full author information from the loaded sutta text
          _computeAuthor() {
              return this.author ? this.author : '';
          }

          // returns the meta-data from the loaded sutta text
          _computeMeta() {
              const matches = this.suttaText.match(/<aside id="metaarea">((.|\n)*)<\/aside>/);
              return matches ? matches[1] : '';
          }

          // After the paragraph list has been loaded, adds relevant data to the placeholders in the sutta text file.
          _computePars(e) {
              const paragraphTitles = e.detail.response;
              for (let key in paragraphTitles) {
                  const refs = this.shadowRoot.querySelectorAll('.' + key);
                  Array.from(refs).forEach(item => item.innerHTML = item.id.replace(key, ''));
                  Array.from(refs).forEach(item => item.title = paragraphTitles[key]);
              }
              if (this.showParagraphs) {
                  this._addParagraphs()
              }
          }

          // Sends title and meta data to the page-selector for use in the header and toolbar-settings-menu.
          sendInfoToToolbar() {
              this.dispatchEvent(new CustomEvent('eventFromTextPage', {
                  detail: {
                      suttatitle: `${this._computeTitle()} â€” ${this._computeAuthor()}`,
                      suttameta: this._computeMeta()
                  },
                  bubbles: true, composed: true
              }));
          }

      }

      customElements.define(SCPageText.is, SCPageText);
  </script>
</dom-module>
