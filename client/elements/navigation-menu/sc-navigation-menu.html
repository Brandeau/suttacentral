<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../styles/sc-scrollbar-style.html">

<dom-module id="sc-navigation-menu">
  <template>
    <style include="sc-scrollbar-style">
      .sc-nav {
        @apply --sc-sans-font;
        user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
      }

      .paper-spinner {
        --paper-spinner-color: var(--primary-color);
      }

      .icon-middle {
        position: absolute;
        margin: 0;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .network-error-icon {
        width: var(--sc-size-xxl);
        height: var(--sc-size-xxl);
      }

      .nav-back-button {
        @apply --sc-skolar-font-size-l;
        background-color: var(--sc-paper-tooltip-color);
        border-top: 1px solid var(--sc-disabled-text-color);
        padding: var(--sc-size-sm);
        display: flex;
        align-items: center;
        font-weight: 600;
        margin: 0;
        z-index: 1;
      }

      .nav-back-button.swap-section {
        height: var(--sc-size-xl);
      }

      .nav-back-title {
        color: var(--sc-disabled-text-color);
        margin-left: var(--sc-size-sm);
        margin-top: var(--sc-size-xxs);
      }

      .swap-section {
        height: 0;
        opacity: 0;
        transition: opacity 1s, transform .5s;
        -webkit-transition: opacity 1s, -webkit-transform .5s;
      }

      .nav .swap-section {
        transition-duration: .3s;
        -webkit-transition-duration: .3s;
      }

      .swap-section.up {
        will-change: transform;
        transform: translateY(-100%);
        -webkit-transform: translateY(-100%);
        -ms-transform: translateY(-100%);
      }

      .swap-section.right {
        will-change: transform;
        transform: translateX(100%);
        -webkit-transform: translateX(100%);
        -ms-transform: translateX(100%);
      }

      .swap-section.left {
        will-change: transform;
        transform: translateX(-100%);
        -webkit-transform: translateX(-100%);
        -ms-transform: translateX(-100%);
      }

      .swap-section.active {
        opacity: 1;
        position: relative;
        -webkit-transform: translate(0, 0);
        -ms-transform: translate(0, 0);
        transform: translate(0, 0);
        width: auto;
      }

      .nav-menu-item {
        list-style-type: none;
        margin: 0 0 var(--sc-size-sm);
        position: relative;
        justify-content: space-between;
        align-items: center;
      }

      .nav-list, .sub-nav {
        list-style-type: none;
        margin: 0;
        padding: var(--sc-size-md) 0;
      }

      .sub-nav-container {
        z-index: 1;
      }

      .nav-link {
        @apply --sc-skolar-font-size-md;
        color: var(--sc-primary-text-color);
        text-transform: uppercase;
        display: block;
        font-weight: 600;
        letter-spacing: .24px;
        padding: 5px 20px;
        text-decoration: none;
        transition: background-color 0.35s cubic-bezier(0.35, 0, 0.25, 1);
        -webkit-transition: background-color 0.35s cubic-bezier(0.35, 0, 0.25, 1);
      }

      .nav-menu-item.selected {
        background: var(--sc-primary-accent-color-almost-transparent);
        color: var(--sc-primary-color-dark);
      }

      .menu-dropdown-icon {
        fill: var(--sc-disabled-text-color);
        display: inline-block;
        position: absolute;
        right: var(--sc-size-sm);
        top: var(--sc-size-xxs);
        transition: .3s ease all;
        cursor: pointer;
      }

      .menu-dropdown-icon.open {
        transform: rotateZ(180deg);
      }

      .nav-menu-item.selected .menu-dropdown-icon {
        background-color: var(--sc-secondary-text-color);
      }

      .nav-secondary, .nav-tertiary {
        margin: var(--sc-size-sm) 0;
        list-style-type: none;
        padding-left: var(--sc-size-sm);
        -webkit-transition: max-height ease-in-out .3s;
        -moz-transition: max-height ease-in-out .3s;
        -ms-transition: max-height ease-in-out .3s;
        -o-transition: max-height ease-in-out .3s;
        transition: max-height ease-in-out .3s;
        overflow: hidden;
      }

      .nav-secondary .nav-link {
        @apply --sc-skolar-font-size-s;
        font-weight: 400;
      }

      .nav-tertiary .nav-link {
        text-transform: none;
        letter-spacing: 0;
        font-weight: 400;
        color: var(--sc-primary-accent-color);
      }

      .nav-secondary.open,
      .nav-tertiary.open {
        max-height: 300px;
      }

      .nav-secondary.closed,
      .nav-tertiary.closed {
        /*display: none;*/
        max-height: 0;
      }

      #main-navigation {
        margin-top: -77px;
        height: auto;
      }

      #back-arrow {
        fill: var(--sc-disabled-text-color);
        cursor: pointer;
        width: var(--sc-size-lg);
        height: var(--sc-size-lg);
      }

    </style>

    <iron-ajax
        auto
        url="[[_getMenuUrl()]]"
        handle-as="json"
        loading="{{loading}}"
        last-error="{{error}}"
        last-response="{{mainMenuResponse}}"
        on-response="_generateMainMenu">
    </iron-ajax>

    <div id="container" class="nav-list-container">
      <template is="dom-if" if="[[_shouldShowLoadingIndicator(loading, error)]]">
        <div class="loading-indicator">
          <paper-spinner-lite class="paper-spinner icon-middle" active="[[loading]]"></paper-spinner-lite>
        </div>
      </template>

      <template is="dom-if" if="[[error]]">
        <iron-icon class="network-error-icon icon-middle" title="Network error" src="img/nonetwork.svg"></iron-icon>
      </template>

      <nav class="sc-nav">
        <div>
          <a id="sub-navigation-header" class="nav-back-button swap-section up">
            <iron-icon id="back-arrow" icon="arrow-back" on-tap="_closeChildMenu"></iron-icon>
            <span class="nav-back-title">Digha Nikaya</span>
          </a>

          <!-- Sub nav menu -->
          <div id="sub-navigation" class="sub-nav-container swap-section right">
            <ul class="sub-nav nav-tertiary open sc-scrollbar">
              <li class="nav-menu-item">
                <div class="nav-section-header">
                  <a class="nav-link" href="/">Chapter on Ethics</a>
                  <iron-icon icon="expand-more" class="menu-dropdown-icon"></iron-icon>
                </div>
              </li>
              <li class="nav-section">
                <div class="nav-section-header">
                  <a class="nav-link" href="/">Second Vagga</a>
                  <paper-icon-button>
                    <iron-icon icon="expand-more" class="menu-dropdown-icon"></iron-icon>
                  </paper-icon-button>
                </div>
              </li>
            </ul>
          </div>

          <!-- Main nav menu -->
          <div id="main_menu_container">

          </div>

          <!--<ul id="main-navigation" class="nav-list sc-scrollbar swap-section left active">-->

            <!--<li class="nav-menu-item">-->
              <!--<span class="nav-link">Sutta</span>-->
              <!--<iron-icon icon="expand-more" class="menu-dropdown-icon open" on-tap="_toggleOpenDropdownMenu"></iron-icon>-->

              <!--<ul class="nav-secondary open">-->
                <!--<li class="nav-menu-item">-->
                  <!--<span class="nav-link">Long</span>-->
                <!--</li>-->
                <!--<li class="nav-menu-item">-->
                  <!--<span class="nav-link">Short</span>-->
                  <!--<iron-icon icon="expand-more" class="menu-dropdown-icon open" on-tap="_toggleOpenDropdownMenu"></iron-icon>-->

                  <!--<ul class="nav-tertiary open">-->
                    <!--<li class="nav-menu-item">-->
                      <!--<a class="nav-link">Digha Nikaya</a>-->
                      <!--<iron-icon icon="arrow-forward" class="menu-dropdown-icon" on-tap="_openChildMenu"></iron-icon>-->
                    <!--</li>-->
                  <!--</ul>-->

                <!--</li>-->
              <!--</ul>-->

            <!--</li>-->

            <!--<li class="nav-menu-item">-->
              <!--<span class="nav-link" href="/">Vinaya</span>-->
              <!--<iron-icon icon="expand-more" class="menu-dropdown-icon" on-tap="_toggleOpenDropdownMenu"></iron-icon>-->
            <!--</li>-->

          <!--</ul>-->

        </div>
      </nav>

    </div>

  </template>

  <script>
      class SCNavigationMenu extends Polymer.Element {
          static get is() {
              return 'sc-navigation-menu';
          }

          static get properties() {
              return {
                  navList: {
                      type: Array,
                      observer: '_parseNavList'
                  },
                  mainMenuResponse: {
                      type: Array,
                      value: []
                  }
              }
          }

          _generateMainMenu() {
              console.dir(this.mainMenuResponse);
              this.$.main_menu_container.innerHTML = `
<ul id="main-navigation" class="nav-list sc-scrollbar swap-section left active">
  ${this.mainMenuResponse.map(item => `
    <li class="nav-menu-item">
      <span class="nav-link">${item.name}</span>
      <iron-icon icon="expand-more" class="menu-dropdown-icon ${item.name === 'Sutta' ? 'open' : ''}" on-tap="_toggleOpenDropdownMenu"></iron-icon>
    </li>`)}
</ul>`;

              Array.from(this.shadowRoot.querySelectorAll('.menu-dropdown-icon')).forEach((dropdownItem) => {
                  dropdownItem.addEventListener('click', this._toggleOpenDropdownMenu);
              });
          }


          _toggleOpenDropdownMenu(e) {
              console.log('tap dropdown')
              // TODO change to [2] after adding iso code svg
              // TODO or use for="uid" attribute in icon element
              const icon = e.path[0];
              const container = e.path[1];
              const childMenu = container.querySelector('ul');
              if (!childMenu) {
                  return;
              }
              if (childMenu.classList.contains('open')) {
                  childMenu.classList.remove('open');
                  childMenu.classList.add('closed');
                  icon.classList.remove('open');
              } else if (childMenu.classList.contains('closed')) {
                  childMenu.classList.remove('closed');
                  childMenu.classList.add('open');
                  icon.classList.add('open');
              }
          }

          _openChildMenu() {
              this.shadowRoot.querySelector('#main-navigation').classList.remove('active');
              this.shadowRoot.querySelector('#sub-navigation').classList.add('active');
              this.shadowRoot.querySelector('#sub-navigation-header').classList.add('active');
          }

          _closeChildMenu() {
              this.shadowRoot.querySelector('#sub-navigation').classList.remove('active');
              this.shadowRoot.querySelector('#sub-navigation-header').classList.remove('active');
              this.shadowRoot.querySelector('#main-navigation').classList.add('active');
          }

          // Open the first two tiers of the sidebar menu and add icons
          _parseNavList() {
              this.navList[0].open = true;
              if (!this.navList[0].children) {
                  return;
              }
              this.navList[0].children.forEach((item) => {
                  item.open = true;
                  item.icon = 'trending-flat';
                  if (!item.children) {
                      return;
                  }
                  item.children.forEach((subItem) => {
                      subItem.icon = 'turned-in';
                  })
              });
          }

          _shouldShowLoadingIndicator(loading, error) {
              return !!(loading && !error);
          }

          _getMenuUrl() {
              return `${this._getApiUrl()}/menu`;
          }

          _getApiUrl() {
              let currentUrl = window.location;
              return `${currentUrl.protocol}//${currentUrl.host}/api`;
          }
      }

      customElements.define(SCNavigationMenu.is, SCNavigationMenu);
  </script>
</dom-module>