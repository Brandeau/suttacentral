<link rel="import" href="/../bower_components/polymer/polymer.html">
<link rel="import" href="/../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="/../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/../bower_components/app-route/app-location.html">
<link rel="import" href="/../bower_components/iron-location/iron-query-params.html">

<link rel="import" href="/../elements/menus/sc-toolbar.html">
<link rel="import" href="/../elements/sc-page-static.html">
<link rel="import" href="/../elements/sc-view-suttaplex.html">
<link rel="import" href="/../elements/sc-page-text.html">
<link rel="import" href="/../elements/sc-segmented-text.html">
<link rel="import" href="/../elements/sc-page-search.html">
<link rel="import" href="/../elements/sc-page-dictionary.html">

<!--
The page-selector loads the top header-bar and the toolbar within that. Depending on the selected page,
the header will have a different appearance and different items in the toolbar.

The page-selector also parses the input-data and loads one of 6 possible page-views depending on the input given:
    - static pages: **sc-page-static.html**
    - search page: **sc-page-search.html**
    - dictionary page: **sc-page-dictionary.html**
    - normal html text pages: **sc-page-text.html**
    - segmented text pages from pootle output: **sc-segmented-text.html**
    - suttaplex list: **sc-view-suttaplex.html**
-->
<dom-module id="page-selector" attributes="togdraw">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        --app-toolbar-font-size: calc(20px * var(--sc-skolar-font-scale));
      }

      .container {
        position: relative;
      }

      .toolbar-header, #sc_toolbar {
        background-color: var(--sc-gold-500);
        white-space: nowrap;
      }

      .list-mode .toolbar-header, .text-mode .toolbar-header, .segmented-mode .toolbar-header {
        @apply --shadow-elevation-8dp;
      }

      .list-mode #sc_toolbar, .list-mode .toolbar-header {
        background-color: var(--paper-deep-orange-900);
      }

      .search-mode #sc_toolbar, .search-mode .toolbar-header, .dictionary-mode #sc_toolbar, .dictionary-mode .toolbar-header {
        background-color: var(--sc-green-600);
      }

      #toolbar_title_box {
        width: 1px;
        z-index: -10;
      }

      #toolbar_title {
        @apply --sc-sans-font;
        text-transform: capitalize;
        color: white;
      }

      .search-mode #toolbar_title, .dictionary-mode #toolbar_title {
        text-transform: none;
      }

      #drawertoggle {
        z-index: 1;
        color: white;
      }

      @media screen and (max-width: 450px) {
        #toolbar_title {
          font-size: calc(16px * var(--sc-skolar-font-scale));
        }
      }

      @media screen and (min-width: 841px) {
        #drawertoggle {
          display: none;
        }
      }
    </style>

    <app-location route={{route}}></app-location>

    <div class="container">
      <app-header-layout>

        <app-header id="header" condenses reveals effects="waterfall" slot="header" class$="[[mainClass]]">
          <app-toolbar class="toolbar-header">
            <paper-icon-button icon="menu" id="drawertoggle" on-tap="_toggleDrawer"></paper-icon-button>

            <div main-title id="toolbar_title_box">
              <p id="toolbar_title">[[toolbarTitle]]</p>
            </div>

            <sc-toolbar id="sc_toolbar"></sc-toolbar>
          </app-toolbar>

        </app-header>

        <template is="dom-if" if="[[shouldShowStaticPage]]">
          <sc-page-static></sc-page-static>
        </template>

        <template is="dom-if" if="[[shouldShowSuttaplexListPage]]" restamp>
          <sc-view-suttaplex></sc-view-suttaplex>
        </template>

        <template is="dom-if" if="[[shouldShowSearchPage]]" restamp>
          <sc-page-search></sc-page-search>
        </template>

        <template is="dom-if" if="[[shouldShowSimpleSuttaPage]]" restamp>
          <sc-page-text sutta-path="[[category]]" author="[[author]]" input-language="[[inputLanguage]]"
                        show-paragraphs="[[showParagraphs]]"></sc-page-text>
        </template>

        <template is="dom-if" if="[[shouldShowSegmentedSuttaPage]]" restamp>
          <sc-segmented-text sutta-path="[[category]]" author="[[author]]" show-viewer="[[showViewer]]"
                             pali-script="[[paliScript]]" input-language="[[inputLanguage]]"
                             show-paragraphs="[[showParagraphs]]"></sc-segmented-text>
        </template>

        <template is="dom-if" if="[[shouldShowDictionaryPage]]" restamp>
          <sc-page-dictionary dictionary-item="[[dictionaryItem]]"
                              input-language="[[inputLanguage]]"></sc-page-dictionary>
        </template>

      </app-header-layout>

    </div>
  </template>

  <script>
      class SCPageSelector extends ReduxMixin(Polymer.Element) {
          static get is() { return 'page-selector'; }

          static get properties() {
              return {
                  divisionTitle: {
                      type: String,
                      notify: true
                  },
                  suttaTitle: {
                      type: String,
                      notify: true
                  },
                  suttaSegTitle: {
                      type: String,
                      notify: true
                  },
                  showViewer: {
                      type: String,
                      notify: true
                  },
                  paliScript: {
                      type: Number,
                      notify: true
                  },
                  showParagraphs: Boolean,
                  category: {
                      type: String,
                      notify: true,
                      observer: '_changeView'
                  },
                  queryParams: {
                      type: Object,
                      notify: true
                  },

                  // Class set on the class on the header depending on the chosen page.
                  mainClass: String,

                  // Defines all the available static pate routes.
                  // See <sc-page-static.html>.
                  staticPages: {
                      type: Array,
                      value: ['HOME', 'DONATIONS', 'DONATE-NOW', 'DOWNLOADS', 'PEOPLE', 'NOT-FOUND']
                  },
                  searchQuery: {
                      type: String,
                      notify: true,
                      computed: '_checkSearchQuery(queryParams)'
                  },
                  dictionaryItem: {
                      type: String,
                      notify: true,
                      computed: '_checkDictionaryItem(subPath,category,activePath)'
                  },
                  route: Object,
                  selectedPage: {
                      type: String,
                      statePath: 'currentRoute.name',
                      observer: '_recalculateView'
                  },
                  categoryId: {
                      type: String,
                      statePath: 'currentRoute.categoryId'
                  },
                  toolbarTitle: {
                      type: String,
                      statePath: 'toolbarTitle'
                  },
                  inputLanguage: {
                      type: String,
                      statePath: 'siteLanguage'
                  },
                  // Variables that control the <dom-if> elements in the template:
                  shouldShowStaticPage: Boolean,
                  shouldShowSuttaplexListPage: Boolean,
                  shouldShowSearchPage: Boolean,
                  shouldShowSimpleSuttaTextPage: Boolean,
                  shouldShowSegmentedSuttaTextPage: Boolean,
                  shouldShowDictionaryPage: Boolean,
                  path: String,
                  query: String
              }
          }

          static get observers() {
              return [
                  '_changeView(category,author)',
                  '_scrollToTop(route)',
                  '_handleRouteChange(route.*)'
              ];
          }

          static get actions() {
              return {
                  changeRoute(route) {
                      return {
                          type: 'CHANGE_ROUTE',
                          route: route
                      };
                  },
                  changeToolbarTitle(title) {
                      return {
                          type: 'CHANGE_TOOLBAR_TITLE',
                          title: title
                      };
                  }
              }
          }

          ready() {
              super.ready();
              // these event listeners listen from input from the latest chosen view to change the title in the toolbar
              this.addEventListener('eventFromTextPage', this.addTitles);
              this.addEventListener('eventFromSegmentedTextPage', this.addTitles);

              // fires if in the settings menu an option is chosen for a certain view i.e. side-by-side, line-by-line, etc.
              // only applies to segmented text pages.
              this.addEventListener('eventFromTools', this.changeSegmentedView);

              // fires if in the settings menu the option "textual information" is chosen. Only applies to text pages.
              this.addEventListener('changeTextInfo', this._changeTextInfo);

              // fires if in the settings menu the option for a change of script is chosen.
              // Only applies to segmented text pages where pali is shown.
              this.addEventListener('changeScript', this._changeScript);
          }

          _recalculateView() {
              this.shouldShowStaticPage = this._isStaticPage();
              this.shouldShowSuttaplexListPage = this._isSuttaplexListPage();
              this.shouldShowSearchPage = this._isSearchPage();
              this.shouldShowSimpleSuttaPage = this._isSimpleSuttaTextPage();
              this.shouldShowSegmentedSuttaPage = this._isSegmentedSuttaTextPage();
              this.shouldShowDictionaryPage = this._isDictionaryPage();
              this._setDisplayOptions();
          }

          // Sets the color of the toolbar (via the mainClass variable) and other display options
          // based on the current route.
          // TODO: dispatch title change events from respective elements
          _setDisplayOptions() {
              if (this.shouldShowStaticPage) {
                  this.mainClass = '';
                  this.dispatch('changeToolbarTitle', '');
              }
              else if (this.shouldShowSuttaplexListPage) {
                  this.mainClass = 'list-mode';
                  this.dispatch('changeToolbarTitle', this.divisionTitle);
              }
              else if (this.shouldShowSearchPage) {
                  this.mainClass = 'search-mode';
                  this.dispatch('changeToolbarTitle', 'SuttaCentral — Search results');
              }
              else if (this.shouldShowSimpleSuttaPage) {
                  this.mainClass = 'text-mode';
                  this.dispatch('changeToolbarTitle', this.suttaTitle);
              }
              else if (this.shouldShowSegmentedSuttaPage) {
                  this.mainClass = 'segmented-mode';
                  this.dispatch('changeToolbarTitle', this.suttaSegTitle);
              }
              else if (this.shouldShowDictionaryPage) {
                  this.mainClass = 'dictionary-mode';
                  this.dispatch('changeToolbarTitle', 'SuttaCentral — dictionary results');
              }
          }

          _isStaticPage() {
              return this.staticPages.includes(this.selectedPage);
          }

          _isSuttaplexListPage() {
              return (this.selectedPage === 'SUTTAPLEX');
          }

          _isSearchPage() {
              return (this.selectedPage === 'SEARCH');
          }

          _isSimpleSuttaTextPage() {
              if (this.selectedPage !== 'SUTTA') {
                  return false;
              }
              const author = this._getPathParamNumber(2);
              return !!(author && author !== 'sujato' && author !== 'pali');
          }

          // checks if a page is a segmented-text page and sets the toolbar title and css class accordingly.
          _isSegmentedSuttaTextPage() {
              if (this.selectedPage !== 'SUTTA') {
                  return false;
              }
              const author = this._getPathParamNumber(2);
              return !!(author && (author === 'sujato' || author === 'pali'));
          }

          // checks if a page is a dictionary page and sets the toolbar title and css class accordingly.
          _isDictionaryPage() {
              return this._getBaseRouteName() === 'DEFINE';

          }

          // Dispatches the CHANGE_ROUTE action with the correct parameters.
          _handleRouteChange() {
              if (this.route.__queryParams === undefined) {
                  return;
              }
              let newRoute;
              const routeName = this._getBaseRouteName();
              switch (routeName) {
                  case '':
                      newRoute = Object.assign({}, this.route, { name: 'HOME' });
                      break;
                  case 'DONATIONS':
                  case 'DONATE-NOW':
                  case 'PEOPLE':
                  case 'DOWNLOADS':
                      newRoute = Object.assign({}, this.route, { name: routeName });
                      break;
                  case 'SUTTAPLEX':
                      newRoute = Object.assign({}, this.route, this._getSuttaplexRouteParams(routeName));
                      break;
                  case 'SUTTA':
                      newRoute = Object.assign({}, this.route, this._getSuttaRouteParams(routeName));
                      break;
                  case 'SEARCH':
                      newRoute = Object.assign({}, this.route, { name: routeName });
                      break;
                  default:
                      newRoute = Object.assign({}, this.route, { name: 'NOT-FOUND' });

              }
              this.dispatch('changeRoute', newRoute);
          }

          _getSuttaplexRouteParams(routeName) {
              return {
                  name: routeName,
                  categoryId: this._getPathParamNumber(2)
              };
          }

          _getSuttaRouteParams(routeName) {
              return {
                  name: routeName,
                  suttaId: this._getPathParamNumber(2),
                  langName: this._getPathParamNumber(3),
                  authorName: this._getPathParamNumber(4)
              };
          }

          // Returns the main path category (first path param). Normalized by converting to upper case.
          _getBaseRouteName() {
              return this.route.path.split('\/')[1].toUpperCase();
          }

          // Returns a nested path parameter.
          // Example:
          // if path = "http://suttacentral.net/sutta/dn1/sujato", _getPathParamNumber(1) returns "dn1".
          _getPathParamNumber(number) {
              try {
                  return this.route.path.split('\/')[number];
              } catch (e) {
                  // TODO show a toast here?
                  console.error(e);
                  return '';
              }
          }

          // changes the title in the toolbar in the settings-menu dialog-box depending on the chosen view
          // TODO: dispatch title change events from respective elements
          addTitles(event) {
              switch (this.mainClass) {
                  case 'list-mode':
                      if (event.detail.divisiontitle) {
                          this.divisionTitle = event.detail.divisiontitle
                      }
                      this.dispatch('changeToolbarTitle', this.divisionTitle);
                      break;
                  case 'text-mode':
                      if (event.detail.suttatitle) {
                          this.suttaTitle = event.detail.suttatitle
                      }
                      this.dispatch('changeToolbarTitle', this.suttaTitle);
                      break;
                  case 'segmented-mode':
                      if (event.detail.suttasegtitle) {
                          this.suttaSegTitle = event.detail.suttasegtitle
                      }
                      this.dispatch('changeToolbarTitle', this.suttaSegTitle);
                      break;
              }
          }

          // set the view-mode for the segmented text pages to the chosen value.
          changeSegmentedView(e) {
              return this.showViewer = e.detail.selectedView;
          }

          // set the textual info-mode for the text pages to the chosen value.
          _changeTextInfo(e) {
              return this.showParagraphs = e.detail.textInfo;
          }

          // set the script type for pali pages in segmented text pages.
          _changeScript(e) {
              return this.paliScript = e.detail.scriptchoice;
          }

          // runs when a new page is chosen. Closes the toolbar-searchbar and resets the header.
          _changeView() {
              this.$.sc_toolbar.closeSearch();
              this.$.header.resetLayout();
          }

          // when the navbar is not visible on small screens, a menu item appears and this fires when tapped.
          _toggleDrawer() {
              this.dispatchEvent(new CustomEvent('toggleDrawer', {
                  detail: { togdraw: 'opened' },
                  composed: true,
                  bubbles: true
              }));
          }

          _scrollToTop() {
              window.scroll(0, 0);
          }

      }

      customElements.define(SCPageSelector.is, SCPageSelector);
  </script>
</dom-module>