<link rel="import" href="/../bower_components/polymer/polymer.html">
<link rel="import" href="/../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="/../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/../bower_components/app-route/app-location.html">
<link rel="import" href="/../bower_components/iron-location/iron-query-params.html">

<link rel="import" href="/../elements/menus/sc-toolbar.html">
<link rel="import" href="/../elements/sc-page-static.html">
<link rel="import" href="/../elements/sc-view-suttaplex.html">
<link rel="import" href="/../elements/sc-page-text.html">
<link rel="import" href="/../elements/sc-segmented-text.html">
<link rel="import" href="/../elements/sc-page-search.html">
<link rel="import" href="/../elements/sc-page-dictionary.html">

<!--
The page-selector loads the top header-bar and the toolbar within that. Depending on the selected page,
the header will have a different appearance and different items in the toolbar.

The page-selector also parses the input-data and loads one of 6 possible page-views depending on the input given:
    - static pages: **sc-page-static.html**
    - search page: **sc-page-search.html**
    - dictionary page: **sc-page-dictionary.html**
    - normal html text pages: **sc-page-text.html**
    - segmented text pages from pootle output: **sc-segmented-text.html**
    - suttaplex list: **sc-view-suttaplex.html**
-->
<dom-module id="page-selector" attributes="togdraw">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        --app-toolbar-font-size: calc(20px * var(--sc-skolar-font-scale));
      }

      .container {
        position: relative;
      }

      .toolbar-header, #sc_toolbar {
        background-color: var(--sc-gold-500);
        white-space: nowrap;
      }

      .list-mode .toolbar-header, .text-mode .toolbar-header, .segmented-mode .toolbar-header {
        @apply --shadow-elevation-8dp;
      }

      .list-mode #sc_toolbar, .list-mode .toolbar-header {
        background-color: var(--paper-deep-orange-900);
      }

      .search-mode #sc_toolbar, .search-mode .toolbar-header, .dictionary-mode #sc_toolbar, .dictionary-mode .toolbar-header {
        background-color: var(--sc-green-600);
      }

      #toolbar_title_box {
        width: 1px;
        z-index: -10;
      }

      #toolbartitle {
        @apply --sc-sans-font;
        text-transform: capitalize;
        color: white;
      }

      .search-mode #toolbartitle, .dictionary-mode #toolbartitle {
        text-transform: none;
      }

      #drawertoggle {
        z-index: 1;
        color: white;
      }

      @media screen and (max-width: 450px) {
        #toolbartitle {
          font-size: calc(16px * var(--sc-skolar-font-scale));
        }
      }

      @media screen and (min-width: 841px) {
        #drawertoggle {
          display: none;
        }
      }
    </style>

    <app-location route={{route}}></app-location>

    <div class="container">
      <app-header-layout>
        <app-header id="header" condenses reveals effects="waterfall" slot="header" class$="[[mainClass]]">
          <app-toolbar class="toolbar-header">
            <paper-icon-button icon="menu" id="drawertoggle" on-tap="_toggleDrawer"></paper-icon-button>

            <div main-title id="toolbar_title_box">
              <p id="toolbar_title">[[toolbarTitle]]</p>
            </div>

            <sc-toolbar id="sc_toolbar" sutta-path="[[author]]" category="[[categoryId]]"></sc-toolbar>
          </app-toolbar>

        </app-header>

        <template is="dom-if" if="[[shouldShowStaticPage]]">
          <sc-page-static></sc-page-static>
        </template>

        <template is="dom-if" if="[[shouldShowSuttaplexList]]" restamp>
          <sc-view-suttaplex></sc-view-suttaplex>
        </template>

        <template is="dom-if" if="[[shouldShowSearchPage]]">
          <sc-page-search></sc-page-search>
        </template>

        <template is="dom-if" if="[[_checkText(category)]]">
          <sc-page-text sutta-path="[[category]]" author="[[author]]" input-language="[[inputLanguage]]"
                        show-paragraphs="[[showParagraphs]]"></sc-page-text>
        </template>

        <template is="dom-if" if="[[_checkSegmented(category)]]">
          <sc-segmented-text sutta-path="[[category]]" author="[[author]]" show-viewer="[[showViewer]]"
                             pali-script="[[paliScript]]" input-language="[[inputLanguage]]"
                             show-paragraphs="[[showParagraphs]]"></sc-segmented-text>
        </template>

        <template is="dom-if" if="[[_checkDictionary(category)]]">
          <sc-page-dictionary dictionary-item="[[dictionaryItem]]"
                              input-language="[[inputLanguage]]"></sc-page-dictionary>
        </template>

      </app-header-layout>

    </div>
  </template>

  <script>
      class SCPageSelector extends ReduxMixin(Polymer.Element) {
          static get is() { return 'page-selector'; }

          static get properties() {
              return {
                  divisionTitle: {
                      type: String,
                      notify: true
                  },
                  suttaTitle: {
                      type: String,
                      notify: true
                  },
                  suttaSegTitle: {
                      type: String,
                      notify: true
                  },
                  showViewer: {
                      type: String,
                      notify: true
                  },
                  paliScript: {
                      type: Number,
                      notify: true
                  },
                  showParagraphs: Boolean,
                  category: {
                      type: String,
                      notify: true,
                      observer: '_changeView'
                  },
                  queryParams: {
                      type: Object,
                      notify: true
                  },

                  // author of the text-page if any.
                  author: {
                      type: String,
                      notify: true,
                      computed: '_checkAuthor(subPath,category,activePath)'
                  },

                  // Class set on the class on the header depending on the chosen page.
                  mainClass: String,

                  // Defines all the available static pate routes.
                  // See <sc-page-static.html>.
                  staticPages: {
                      type: Array,
                      value: ['HOME', 'DONATIONS', 'DONATE-NOW', 'DOWNLOADS', 'PEOPLE', 'NOT-FOUND']
                  },
                  searchQuery: {
                      type: String,
                      notify: true,
                      computed: '_checkSearchQuery(queryParams)'
                  },
                  dictionaryItem: {
                      type: String,
                      notify: true,
                      computed: '_checkDictionaryItem(subPath,category,activePath)'
                  },
                  route: Object,
                  selectedPage: {
                      type: String,
                      statePath: 'currentRoute.name',
                      observer: '_recalculateView'
                  },
                  categoryId: {
                      type: String,
                      statePath: 'currentRoute.categoryId'
                  },
                  toolbarTitle: {
                      type: String,
                      statePath: 'toolbarTitle'
                  },
                  inputLanguage: {
                      type: String,
                      statePath: 'siteLanguage'
                  },
                  // Variables that control the <dom-if> elements in the template:
                  shouldShowStaticPage: Boolean,
                  shouldShowSuttaplexList: Boolean,
                  shouldShowSingleSuttaplex: Boolean,
                  shouldShowSearchPage: Boolean,
                  shouldShowSimpleSuttaView: Boolean,
                  path: String,
                  query: String
              }
          }

          static get observers() {
              return [
                  '_changeView(category,author)',
                  '_scrollToTop(route)',
                  '_handleRouteChange(route.*)'
              ];
          }

          static get actions() {
              return {
                  changeRoute(route) {
                      return {
                          type: 'CHANGE_ROUTE',
                          route: route
                      };
                  },
                  changeToolbarTitle(title) {
                      return {
                          type: 'CHANGE_TOOLBAR_TITLE',
                          title: title
                      };
                  }
              }
          }

          ready() {
              super.ready();
              // these event listeners listen from input from the latest chosen view to change the title in the toolbar
              this.addEventListener('eventFromTextPage', this.addTitles);
              this.addEventListener('eventFromSegmentedTextPage', this.addTitles);

              // fires if in the settings menu an option is chosen for a certain view i.e. side-by-side, line-by-line, etc.
              // only applies to segmented text pages.
              this.addEventListener('eventFromTools', this.changeSegmentedView);

              // fires if in the settings menu the option "textual information" is chosen. Only applies to text pages.
              this.addEventListener('changeTextInfo', this._changeTextInfo);

              // fires if in the settings menu the option for a change of script is chosen.
              // Only applies to segmented text pages where pali is shown.
              this.addEventListener('changeScript', this._changeScript);
          }

          _recalculateView() {
              this.shouldShowStaticPage = this._isStaticPage();
              this.shouldShowSuttaplexList = this._isSuttaplexList();
              this.shouldShowSearchPage = this._isSearchPage();
              this._setDisplayOptions();
          }

          _isStaticPage() {
              return this.staticPages.includes(this.selectedPage);
          }

          _isSuttaplexList() {
              return (this.selectedPage === 'SUTTAPLEX');
          }

          _isSearchPage() {
              return (this.selectedPage === 'SEARCH');
          }

          _handleRouteChange(routeName) {
              if (this.route.__queryParams === undefined) {
                  return;
              }
              let currentRoute;
              // Normalize the URL:
              routeName = this._computeRouteName(this.route.path).toUpperCase();
              switch (routeName) {
                  case '':
                      currentRoute = Object.assign({}, this.route, { name: 'HOME' });
                      break;
                  case 'DONATIONS':
                  case 'PEOPLE':
                  case 'DOWNLOADS':
                      currentRoute = Object.assign({}, this.route, { name: routeName });
                      break;
                  case 'SUTTAPLEX':
                      currentRoute = Object.assign({}, this.route, {
                          name: routeName,
                          categoryId: this._getPathParamNumber(2)
                      });
                      break;
                  case 'SEARCH':
                      currentRoute = Object.assign({}, this.route, { name: routeName });
                      break;
                  default:
                      currentRoute = Object.assign({}, this.route, { name: 'NOT-FOUND' });

              }
              this.dispatch('changeRoute', currentRoute);
          }

          // Returns the main path category (first path param).
          _computeRouteName(routePath) {
              return routePath.split('\/')[1];
          }

          // Returns a nested path parameter.
          // Example:
          // if path = "http://suttacentral.net/sutta/dn1/sujato", _getPathParamNumber(1) returns "dn1".
          _getPathParamNumber(number) {
              try {
                  return this.route.path.split('\/')[number];
              } catch (e) {
                  // TODO show a toast here?
                  console.error(e);
                  return '';
              }
          }

          // Sets the color of the toolbar (via the mainClass variable) and other display options
          // based on the current route.
          _setDisplayOptions() {
              if (this.shouldShowStaticPage) {
                  this.mainClass = '';
              }
              else if (this.shouldShowSuttaplexList || this.shouldShowSingleSuttaplex) {
                  this.mainClass = 'list-mode';
                  this.dispatch('changeToolbarTitle', this.divisionTitle);
              }
              else if (this.shouldShowSearchPage) {
                  this.mainClass = 'search-mode';
                  this.dispatch('changeToolbarTitle', 'SuttaCentral — search results');
              }
          }

          // changes the title in the toolbar in the settings-menu dialog-box depending on the chosen view
          addTitles(event) {
              switch (this.mainClass) {
                  case 'list-mode':
                      if (event.detail.divisiontitle) {
                          this.divisionTitle = event.detail.divisiontitle
                      }
                      this.toolbarTitle = this.divisionTitle;
                      break;
                  case 'text-mode':
                      if (event.detail.suttatitle) {
                          this.suttaTitle = event.detail.suttatitle
                      }
                      this.toolbarTitle = this.suttaTitle;
                      break;
                  case 'segmented-mode':
                      if (event.detail.suttasegtitle) {
                          this.suttaSegTitle = event.detail.suttasegtitle
                      }
                      this.toolbarTitle = this.suttaSegTitle;
                      break;
              }
          }

          // find the author name in the route: The additional check for "activePath" is needed because otherwise the
          // different views for different vaggas vs. the full view of all the vaggas is not always taken.
          // Note that this will have to be changed for longer and more complex routes.
          _checkAuthor(subPath, category, activePath) {
              return (category !== 'define' && subPath && activePath && !subPath.startsWith('vagga')) ? subPath : '';
          }

          // find the vagga name in the route. The additional check for "activePath" is needed because otherwise the
          // different views for different vaggas vs. the full view of all the vaggas is not always taken.
          // Note that this will have to be changed for longer and more complex routes.
          _computeVagga(subPath, activePath) {
              return (subPath && activePath && subPath.startsWith('vagga')) ? subPath : '';
          }

          // if there are query parameters given, then pass this info to the search page.
          _checkSearchQuery(queryParams) {
              return (queryParams.query) ? queryParams.query : '';
          }

          // if the first term of the route = "define", pass the second term as dictionary-search-term to the dictionary page.
          _checkDictionaryItem(subPath, category, activePath) {
              return (activePath && category === 'define') ? subPath : '';
          }

          // set the view-mode for the segmented text pages to the chosen value.
          changeSegmentedView(e) {
              return this.showViewer = e.detail.selectedView;
          }

          // set the textual info-mode for the text pages to the chosen value.
          _changeTextInfo(e) {
              return this.showParagraphs = e.detail.textInfo;
          }

          // set the script type for pali pages in segmented text pages.
          _changeScript(e) {
              return this.paliScript = e.detail.scriptchoice;
          }

          // runs when a new page is chosen. Closes the toolbar-searchbar and resets the header.
          _changeView(category, author) {
              this.$.sc_toolbar.closeSearch();
              this.$.header.resetLayout();
          }

          // when the navbar is not visible on small screens, a menu item appears and this fires when tapped.
          _toggleDrawer() {
              this.dispatchEvent(new CustomEvent('toggleDrawer', {
                  detail: { togdraw: 'opened' },
                  composed: true,
                  bubbles: true
              }));
          }

          // checks if a page is a html-text page by checking and sets the toolbar title and css class accordingly.
          _checkText(category) {
              const author = this._checkAuthor(this.subPath, category, this.activePath);
              if (author && author !== 'sujato' && author !== 'pali') {
                  this.mainClass = 'text-mode';
                  this.dispatch('changeToolbarTitle', this.suttaTitle);
                  return true;
              } else {
                  return false;
              }
          }

          // checks if a page is a segmented-text page and sets the toolbar title and css class accordingly.
          _checkSegmented(category) {
              const author = this._checkAuthor(this.subPath, category, this.activePath);
              if (author && (author === 'sujato' || author === 'pali')) {
                  this.mainClass = 'segmented-mode';
                  this.dispatch('changeToolbarTitle', this.suttaSegTitle);
                  return true;
              } else {
                  return false;
              }
          }

          // checks if a page is a dictionary page and sets the toolbar title and css class accordingly.
          _checkDictionary(category) {
              if (category === 'define') {
                  this.mainClass = 'dictionary-mode';
                  this.dispatch('changeToolbarTitle', 'SuttaCentral — dictionary results');
                  return true;
              } else {
                  return false;
              }
          }

          _scrollToTop() {
              window.scroll(0, 0);
          }

      }

      customElements.define(SCPageSelector.is, SCPageSelector);
  </script>
</dom-module>