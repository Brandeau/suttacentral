<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="menus/language-menu.html">
<link rel="import" href="../styles/sc-styles.html">
<link rel="import" href="addons/sc-sutta-note.html">
<link rel="import" href="sc-view-parallels.html">
<link rel="import" href="menus/more-par-menu.html">
<link rel="import" href="../styles/sc-suttaplex-styles.html">

<link rel="import" href="../img/sc-svg-icons.html">

<dom-module id="sc-suttaplex" attributes="open url">
<template>
<style is="custom-style" include="sc-suttaplex-styles">
.heading {
  cursor: pointer;
}

.suttaplex-head-container{
    display:flex;
    justify-content: space-between;
    align-items: center;
}

h1, h2, h3 {
  margin: 0;
}

paper-card.suttaplex {
    border-radius: 0px;
    border-top: 1px solid var(--paper-grey-300);
    display:block;
}
paper-card.suttaplex .card-content {
    padding-top: 24px;
    padding-bottom: 1px;
}

.suttaplex-heading {
  @apply(--paper-font-headline);
  @apply(--sc-serif-font);
}

.suttaplex-nerdy-row {
  @apply(--paper-font-body2);
  color: var(--secondary-text-color);
  white-space: nowrap;
  overflow: hidden;
}
.suttaplex-nerdy-row span {
  margin-right: 24px;
}

.suttaplex-nerdy-row span:nth-of-type(1){
  @apply(--sc-all-small-caps);
}

.suttaplex-description{
  @apply(--sc-paper-font-body);
   overflow: hidden;
}

paper-card.suttaplex .card-actions {
    padding: 0px 16px 8px;
    display:flex;
    justify-content: space-between;
    align-items: baseline;
    border-top:0;
}
.card-actions-left {
    display: inline-block;
}
.card-actions-right {
    display: inline-block;
}

.languagedrop {
  display: inline-block;
  vertical-align:middle;
  margin:-18px 4px 0;
  padding: 0 8px;
}

paper-badge {
  --paper-badge-background: var(--paper-green-a700);
}

#moremenu {
  visibility:hidden;
}
summary::-webkit-details-marker{
  color:var(--paper-grey-300);
}
details {
  display: inline-block;
}
details p {
  @apply(--paper-font-body1);
  position:absolute;
  z-index:200;
  background-color:#fff;
  @apply(--shadow-elevation-3dp);
  padding:12px;
  border-top: 1px solid rgba(0, 0, 0, 0.12);
  margin: 0 48px 0 0;
  white-space: normal;
}

paper-menu-button {
  padding:0;
}
</style>

<iron-ajax id="ajax"
      url="[[_computeURL(inputUrl)]]"
      handle-as="json"
      last-response="{{inputData}}"></iron-ajax>

  <paper-card class="suttaplex" id="{{inputData.url}}">
      <div class="card-content">

        <div class="suttaplex-head-container">
          <template is="dom-if" if="[[languageData.titlelan]]">
            <h3 class="suttaplex-heading" title="Translated title">{{languageData.titlelan}}</h3>
          </template>
          <template is="dom-if" if="[[!languageData.titlelan]]">
            <template is="dom-if" if="[[inputData.titlepi]]">
              <h3 class="suttaplex-heading" title="Original title">[[inputData.titlepi]]</h3>
            </template>
            <template is="dom-if" if="[[!inputData.titlepi]]">
              <h3 class="suttaplex-heading" title="SuttaCentral ID">[[inputData.id]]</h3>
            </template>
          </template>
          <div class$="difficulty-icon [[inputData.level]]" title="Recommended for [[inputData.level]] students"><iron-icon icon="[[_computeLevel(inputData.level)]]"></iron-icon></div>
        </div>

        <div class="suttaplex-nerdy-row">
          <template is="dom-if" if="[[inputData.titlepi]]">
            <span title="Original title">[[inputData.titlepi]]</span>
          </template>
          <span title="SuttaCentral ID">[[inputData.id]]</span>
          <template is="dom-if" if="[[inputData.volpage]]">
            <template is="dom-if" if="[[inputData.bib]]">
                <details><summary>
                <span class="book" style="margin:0"><iron-icon icon="book"></iron-icon></span>
                <span class="vol-page" title="Volume and page">[[inputData.volpage]]</span></summary><p inner-h-t-m-l="{{inputData.bib}}"></p></details>
            </template>
            <template is="dom-if" if="[[!inputData.bib]]">
                <span class="book" style="margin:0"><iron-icon icon="book"></iron-icon></span>
                <span class="vol-page" title="Volume and page">[[inputData.volpage]]</span>
            </template>
          </template>
          <template is="dom-if" if="[[inputData.note]]">
            <sc-sutta-note note-data="{{inputData.note}}"></sc-sutta-note>
          </template>
        </div>

        <template is="dom-if" if="[[languageData.slug]]">
            <p class="suttaplex-description" title="Description">[[languageData.slug]]</p>
        </template>
      </div>
      <div class="card-actions">
        <div class="card-actions-left">
            <template is="dom-repeat" items="{{languageData.authors}}" as="author">
                <paper-button flat title$="Go to a translation by {{author}}"><a href="/[[inputData.url]]/[[author]]">{{author}}</a></paper-button>
            </template>
            <div class="languagedrop"><language-menu language-choice="{{inputData.languages}}" title-label="Other" input-language="{{inputLanguage}}" original-language="{{inputData.orlan}}" input-url="[[inputUrl]]"></language-menu></div>
        </div>
        <template is="dom-if" if="{{inputData.parallels}}">
            <div class="card-actions-right">
                <paper-menu-button horizontal-align="right" id="[[_toggleMoreIcon]]">
                  <paper-icon-button class="dropdown-trigger" icon="icons:more-vert"></paper-icon-button>
                  <div class="dropdown-content"></div>
                  <paper-menu class="dropdown-content" tabindex="0">
                      <more-par-menu input-url="{{inputUrl}}"></more-par-menu>
                  </paper-menu>
                </paper-menu-button>
                <span class="heading" title="View Parallels & References" on-tap="_toggleOpened">
                  <paper-icon-button icon="[[_toggleIcon]]" on-tap="passParams"></paper-icon-button>
                  <paper-badge label="{{_parallelsNumber(inputData)}}" title$="This text has {{inputData.parallels}} parallels"></paper-badge>
                </span>
            </div>
        </template>
      </div>
      <template is="dom-if" if="{{inputData.parallels}}">
        <iron-collapse id$="collapse{{inputUrl}}" opened="{{opened}}">
			      <sc-view-parallels show-parallel="{{inputData.parallels}}" input-url="[[inputUrl]]" input-language="{{inputLanguage}}" original-language="{{inputData.orlan}}"></sc-view-parallels>
        </iron-collapse>
      </template>
  </paper-card>

</template>
<script>
    Polymer({
      is: 'sc-suttaplex',
      properties: {

        inputUrl: {
          type: String,
          observer: '_callAjax'
        },
        inputLanguage: String,

        languageData: {
          type: Object,
          computed: '_computeLanguage(inputData,inputLanguage)'
        },
        vaggaNumber: String,

        opened: {
          type: Boolean,
          reflectToAttribute: true,
          notify: true
        },
        toggleRequest: Boolean,
        _toggleIcon: {
          type: String,
          computed: '_computeToggleIcon(opened)'
        },
        _toggleMoreIcon: {
          type: String,
          computed: '_computeToggleMoreIcon(opened)'
        }
      },
      ready: function() {
        if (this.toggleRequest) {this._toggleOpened()}
      },
      _callAjax: function() {
        if (this.inputUrl) {var matches = this.inputUrl.match(/\d{1,6}/)};
        return (matches) ? this.$.ajax.generateRequest() : "";
      },
      _computeToggleIcon: function(opened) {
        return opened ? 'icons:expand-less' : 'icons:expand-more';
      },
      _computeToggleMoreIcon: function(opened) {
        return opened ? '' : 'moremenu';
      },
      _toggleOpened: function(e) {
  	this.opened = !this.opened;
  	this.fire('toggle', this);
      },
      _checkToggleRequest: function(toggleRequest) {
        if (toggleRequest) {this._toggleOpened};
      },
      passParams: function() {
        this.fire('toggleParallelNote',{open:this._toggleIcon, url:this.inputUrl});
      },
      _computeLevel: function(level) {
        return level ? "sc-svg-icons:"+level : "";
      },
      _computeURL: function(sutta) {
          return `../../data/suttas/${sutta}.json`;
      },
      _computeLanguage: function(inputData,inputLanguage) {
        var lanarray = "";
        if (inputData.languages){
          for (var i=0; i<inputData.languages.length; i=i+1) {
            if (inputData.languages[i].id === inputLanguage) {
              var lanarray = inputData.languages[i]
            }
          }
        }
        return lanarray ? lanarray : "";
      },
      _parallelsNumber: function(inputData) {
        var parlength = 0;
        for (var i=0; i<inputData.parallels.length; i=i+1) {
          parlength = parlength + inputData.parallels[i].relations.length;
        }
        return parlength;
      }

    });
</script>
</dom-module>
