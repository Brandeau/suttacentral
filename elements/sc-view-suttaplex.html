<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="sc-suttaplex.html">
<link rel="import" href="addons/sc-node.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">

<dom-module id="sc-view-suttaplex" attributes="divisiontitle">
<template>
<style is="custom-style">
.divisioncontent {
  color: var(--primary-text-color);
  padding: 24px 0;
  background-color:var(--paper-grey-100);
}

main {
  margin: 0 auto;
  max-width: 720px;
}

.suttalist {
  margin: 0 auto;
  max-width: 720px;
  transition: margin-top 0.3s, margin-bottom 0.3s;
}
.title {
  margin-left: 64px;
}
.suttalist.expandeditem {
  @apply(--shadow-elevation-8dp);
  margin-top:20px;
  margin-bottom: 20px;
}
.node {
    padding: 16px 16px 0;
    color: var(--secondary-text-color);
}
.vagganode{
    padding: 24px 16px 16px;
    color: var(--secondary-text-color);
}
.vagganode.firstvagga, .node+.vagganode {
  padding-top: 0;
}
  paper-spinner-lite {
    --paper-spinner-color: var(--sc-gold-500);
    left: 50%;
    top: 50px;
  }
</style>
<iron-ajax id="ajax"
      url="[[_computeURL(category)]]"
      handle-as="json"
      loading="{{loadingResults}}"
      last-response="{{suttaList}}"></iron-ajax>

    <div class="loadingIndicator">
      <paper-spinner-lite active="{{loadingResults}}"></paper-spinner-lite>
    </div>

<div class="divisioncontent">
  <main>

        <template is="dom-if" if="{{_checkCategoryRoute(category)}}">

            <section class="node">
                <sc-node input-title="{{languageData.name}}" input-text="{{languageData.description}}" style-header="node-top-heading"></sc-node>
            </section>

            <template is="dom-repeat" items="{{suttaList.vaggas}}" as="vagga">
              <template is="dom-if" if="{{_selectVagga(vagga,vaggaNumber)}}">
                    <section class$="vagganode {{_checkFirstVagga(vagga,vaggaNumber)}}">
                      <sc-node input-title="{{_computeVagganame(vagga,inputLanguage)}}" input-text="{{_computeVaggadescription(vagga,inputLanguage)}}" style-header="node-secondary-heading"></sc-node>
                    </section>

                    <template is="dom-repeat" items="{{vagga.suttas}}" as="item">
                      <div class="suttalist" id$="{{item}}">
                        <sc-suttaplex input-url="{{item}}" input-language="{{inputLanguage}}"></sc-suttaplex>
                      </div>
                    </template>
                </template>
            </template>
        </template>

        <template is="dom-if" if="{{!_checkCategoryRoute(category)}}">
            <template is="dom-if" if="{{!activePath}}">
                      <div class="suttalist" id="{{category}}">
                        <sc-suttaplex input-url="{{category}}" toggle-request input-language="{{inputLanguage}}"></sc-suttaplex>
                      </div>
            </template>
        </template>

  </main>
</div>
</template>
<script>
    Polymer({
      is: 'sc-view-suttaplex',
      properties: {
        inputLanguage: String,
        suttaList: {
          type: Object,
          notify: true,
        },
        activePath: Boolean,
        languageData: {
          type: Object,
          computed: '_computeLanguage(suttaList,inputLanguage)'
        },
        vaggaNumber: {
          type: String,
          value: ""
        },
        category: {
          type: String,
          notify: true,
          observer: '_callAjax'
        },
        otherPages: {
          type: Array,
          value: ["dons","people","downloads","","search","define"]
        },
      },
      observers: [
        'infoToParent(suttaList,inputLanguage)'
      ],
      ready: function() {
        this.addEventListener('toggleParallelNote', this.elevateBox);
      },
      _checkCategoryRoute: function(category) {
        if (category) {var matches = category.match(/\d{1,6}/)};
        // var test = document.getElementById("dn/vagga2");
        // console.log(test);
        // test.classList.add("selected");
        return (!matches) ? true : false;
      },
      _callAjax: function() {
        if (this.category) {var matches = this.category.match(/\d{1,6}/)};
        return (!matches && (this.otherPages.indexOf(this.category) == -1)) ? this.$.ajax.generateRequest() : "";
      },
      elevateBox: function(event) {
        var sutta = document.getElementById(event.detail.url);
        return (event.detail.open === "icons:expand-more") ? sutta.classList.add('expandeditem') : sutta.classList.remove('expandeditem');
      },
      _computeURL: function(category) {
        return `../../data/list/${category}.json`;
      },
      _selectVagga: function(vagga,vaggaNumber) {
        return (vaggaNumber === undefined || vaggaNumber === "" || vaggaNumber === vagga.vagganr) ? true : false;
      },
      _checkFirstVagga: function(vagga,vaggaNumber) {
        return vaggaNumber ? ((vaggaNumber == vagga.vagganr) ? "firstvagga" : "") : "";
      },
      _computeLanguage: function(suttaList,inputLanguage) {
        return suttaList ? suttaList[inputLanguage] : "";
      },
      _computeVagganame: function(vagga,inputLanguage) {
        return vagga[inputLanguage].vagganame;
      },
      _computeVaggadescription: function(vagga,inputLanguage) {
        return vagga[inputLanguage].description;
      },
      infoToParent: function(suttaList,inputLanguage) {
        if (suttaList) {
        this.fire('eventFromSuttaplexPage',{divisiontitle:this._computeLanguage(suttaList,inputLanguage)['name']+"â€”"+suttaList['namepi']});
        }
      }
    });

</script>
</dom-module>

